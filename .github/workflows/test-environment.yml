name: Test Environment Setup

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-setup:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv (Unix)
        if: runner.os != 'Windows'
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install uv (Windows)
        if: runner.os == 'Windows'
        run: powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"

      - name: Add uv to PATH (Unix)
        if: runner.os != 'Windows'
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Add uv to PATH (Windows)
        if: runner.os == 'Windows'
        run: echo "$env:USERPROFILE\.cargo\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify uv installation
        run: uv --version

      - name: Sync environment
        run: uv sync

      - name: Test Python imports
        run: |
          uv run python -c "import numpy; print(f'NumPy version: {numpy.__version__}')"
          uv run python -c "import astropy; print(f'Astropy version: {astropy.__version__}')"
          uv run python -c "import pandas; print(f'Pandas version: {pandas.__version__}')"
          uv run python -c "import scipy; print(f'SciPy version: {scipy.__version__}')"
          uv run python -c "import astroquery; print('Astroquery imported successfully')"
          uv run python -c "import photutils; print('Photutils imported successfully')"
          uv run python -c "import ccdproc; print('CCDProc imported successfully')"

      - name: Test all package imports
        run: |
          uv run python -c "
          import sys
          packages = [
              'numpy', 'scipy', 'pandas', 'astropy', 'astropy_healpix',
              'astroquery', 'photutils', 'ccdproc', 
              'jupyter', 'pyvo', 'requests', 'astroid'
          ]
          failed = []
          for package in packages:
              try:
                  __import__(package)
                  print(f'✓ {package}')
              except ImportError as e:
                  print(f'✗ {package}: {e}')
                  failed.append(package)

          if failed:
              print(f'\nFailed to import: {failed}')
              sys.exit(1)
          else:
              print('\n✓ All packages imported successfully!')
          "

      - name: Test Jupyter installation
        run: uv run jupyter --version

      - name: Test Python version requirement
        run: |
          uv run python -c "
          import sys
          version = sys.version_info
          print(f'Python version: {version.major}.{version.minor}.{version.micro}')
          if version.major < 3 or (version.major == 3 and version.minor < 11):
              print('ERROR: Python version must be >= 3.11')
              sys.exit(1)
          print('✓ Python version requirement met')
          "
